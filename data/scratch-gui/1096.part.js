/* 1096 */\n (function(module, exports, __webpack_require__) {\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it.return != null) it.return(); } finally { if (didErr) throw err; } } }; }\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\nvar ArgumentType = __webpack_require__(63);\nvar BlockType = __webpack_require__(45);\nvar Cast = __webpack_require__(48);\nvar formatMessage = __webpack_require__(71);\nvar uid = __webpack_require__(94);\nvar BT = __webpack_require__(1097);\nvar Base64Util = __webpack_require__(182);\nvar MathUtil = __webpack_require__(62);\nvar RateLimiter = __webpack_require__(298);\nvar log = __webpack_require__(39);\n/**\n * Icon svg to be displayed at the left edge of each extension block, encoded as a data URI.\n * @type {string}\n */\n// eslint-disable-next-line max-len\nvar blockIconURI = 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNDBweCIgaGVpZ2h0PSI0MHB4IiB2aWV3Qm94PSIwIDAgNDAgNDAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDUwLjIgKDU1MDQ3KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5ldjMtYmxvY2staWNvbjwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPjwvZGVmcz4KICAgIDxnIGlkPSJldjMtYmxvY2staWNvbiIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImV2MyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNS41MDAwMDAsIDMuNTAwMDAwKSIgZmlsbC1ydWxlPSJub256ZXJvIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS1wYXRoIiBzdHJva2U9IiM3Qzg3QTUiIGZpbGw9IiNGRkZGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgeD0iMC41IiB5PSIzLjU5IiB3aWR0aD0iMjgiIGhlaWdodD0iMjUuODEiIHJ4PSIxIj48L3JlY3Q+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtcGF0aCIgc3Ryb2tlPSIjN0M4N0E1IiBmaWxsPSIjRTZFN0U4IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHg9IjIuNSIgeT0iMC41IiB3aWR0aD0iMjQiIGhlaWdodD0iMzIiIHJ4PSIxIj48L3JlY3Q+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtcGF0aCIgc3Ryb2tlPSIjN0M4N0E1IiBmaWxsPSIjRkZGRkZGIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHg9IjIuNSIgeT0iMTQuNSIgd2lkdGg9IjI0IiBoZWlnaHQ9IjEzIj48L3JlY3Q+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0xNC41LDEwLjUgTDE0LjUsMTQuNSIgaWQ9IlNoYXBlIiBzdHJva2U9IiM3Qzg3QTUiIGZpbGw9IiNFNkU3RTgiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PC9wYXRoPgogICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLXBhdGgiIGZpbGw9IiM0MTQ3NTciIHg9IjQuNSIgeT0iMi41IiB3aWR0aD0iMjAiIGhlaWdodD0iMTAiIHJ4PSIxIj48L3JlY3Q+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtcGF0aCIgZmlsbD0iIzdDODdBNSIgb3BhY2l0eT0iMC41IiB4PSIxMy41IiB5PSIyMC4xMyIgd2lkdGg9IjIiIGhlaWdodD0iMiIgcng9IjAuNSI+PC9yZWN0PgogICAgICAgICAgICA8cGF0aCBkPSJNOS4wNiwyMC4xMyBMMTAuNTYsMjAuMTMgQzEwLjgzNjE0MjQsMjAuMTMgMTEuMDYsMjAuMzUzODU3NiAxMS4wNiwyMC42MyBMMTEuMDYsMjEuNjMgQzExLjA2LDIxLjkwNjE0MjQgMTAuODM2MTQyNCwyMi4xMyAxMC41NiwyMi4xMyBMOS4wNiwyMi4xMyBDOC41MDc3MTUyNSwyMi4xMyA4LjA2LDIxLjY4MjI4NDcgOC4wNiwyMS4xMyBDOC4wNiwyMC41Nzc3MTUzIDguNTA3NzE1MjUsMjAuMTMgOS4wNiwyMC4xMyBaIiBpZD0iU2hhcGUiIGZpbGw9IiM3Qzg3QTUiIG9wYWNpdHk9IjAuNSI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNMTguOTEsMjAuMTMgTDIwLjQyLDIwLjEzIEMyMC42OTYxNDI0LDIwLjEzIDIwLjkyLDIwLjM1Mzg1NzYgMjAuOTIsMjAuNjMgTDIwLjkyLDIxLjYzIEMyMC45MiwyMS45MDYxNDI0IDIwLjY5NjE0MjQsMjIuMTMgMjAuNDIsMjIuMTMgTDE4LjkyLDIyLjEzIEMxOC4zNjc3MTUzLDIyLjEzIDE3LjkyLDIxLjY4MjI4NDcgMTcuOTIsMjEuMTMgQzE3LjkxOTk3MjYsMjAuNTgxNTk3IDE4LjM2MTYyNDUsMjAuMTM1NDg0IDE4LjkxLDIwLjEzIFoiIGlkPSJTaGFwZSIgZmlsbD0iIzdDODdBNSIgb3BhY2l0eT0iMC41IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxOS40MjAwMDAsIDIxLjEzMDAwMCkgcm90YXRlKC0xODAuMDAwMDAwKSB0cmFuc2xhdGUoLTE5LjQyMDAwMCwgLTIxLjEzMDAwMCkgIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik04LjIzLDE3LjUgTDUsMTcuNSBDNC43MjM4NTc2MywxNy41IDQuNSwxNy4yNzYxNDI0IDQuNSwxNyBMNC41LDE0LjUgTDEwLjUsMTQuNSBMOC42NSwxNy4yOCBDOC41NTQ2Njk2MSwxNy40MTc5MDgyIDguMzk3NjUwMDYsMTcuNTAwMTU2NiA4LjIzLDE3LjUgWiIgaWQ9IlNoYXBlIiBmaWxsPSIjN0M4N0E1IiBvcGFjaXR5PSIwLjUiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTE4LjE1LDE4Ljg1IEwxNy42NSwxOS4zNSBDMTcuNTUyMzQxNiwxOS40NDQwNzU2IDE3LjQ5ODAzMzksMTkuNTc0NDE0MiAxNy41LDE5LjcxIEwxNy41LDIwIEMxNy41LDIwLjI3NjE0MjQgMTcuMjc2MTQyNCwyMC41IDE3LDIwLjUgTDE2LjUsMjAuNSBDMTYuMjIzODU3NiwyMC41IDE2LDIwLjI3NjE0MjQgMTYsMjAgQzE2LDE5LjcyMzg1NzYgMTUuNzc2MTQyNCwxOS41IDE1LjUsMTkuNSBMMTMuNSwxOS41IEMxMy4yMjM4NTc2LDE5LjUgMTMsMTkuNzIzODU3NiAxMywyMCBDMTMsMjAuMjc2MTQyNCAxMi43NzYxNDI0LDIwLjUgMTIuNSwyMC41IEwxMiwyMC41IEMxMS43MjM4NTc2LDIwLjUgMTEuNSwyMC4yNzYxNDI0IDExLjUsMjAgTDExLjUsMTkuNzEgQzExLjUwMTk2NjEsMTkuNTc0NDE0MiAxMS40NDc2NTg0LDE5LjQ0NDA3NTYgMTEuMzUsMTkuMzUgTDEwLjg1LDE4Ljg1IEMxMC42NTgyMTY3LDE4LjY1MjE4NjMgMTAuNjU4MjE2NywxOC4zMzc4MTM3IDEwLjg1LDE4LjE0IEwxMi4zNiwxNi42NSBDMTIuNDUwMjgwMywxNi41NTI4NjE3IDEyLjU3NzM5NjEsMTYuNDk4MzgzNSAxMi43MSwxNi41IEwxNi4yOSwxNi41IEMxNi40MjI2MDM5LDE2LjQ5ODM4MzUgMTYuNTQ5NzE5NywxNi41NTI4NjE3IDE2LjY0LDE2LjY1IEwxOC4xNSwxOC4xNCBDMTguMzQxNzgzMywxOC4zMzc4MTM3IDE4LjM0MTc4MzMsMTguNjUyMTg2MyAxOC4xNSwxOC44NSBaIiBpZD0iU2hhcGUiIGZpbGw9IiM3Qzg3QTUiIG9wYWNpdHk9IjAuNSI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNMTAuODUsMjMuNDUgTDExLjM1LDIyLjk1IEMxMS40NDc2NTg0LDIyLjg1NTkyNDQgMTEuNTAxOTY2MSwyMi43MjU1ODU4IDExLjUsMjIuNTkgTDExLjUsMjIuMyBDMTEuNSwyMi4wMjM4NTc2IDExLjcyMzg1NzYsMjEuOCAxMiwyMS44IEwxMi41LDIxLjggQzEyLjc3NjE0MjQsMjEuOCAxMywyMi4wMjM4NTc2IDEzLDIyLjMgQzEzLDIyLjU3NjE0MjQgMTMuMjIzODU3NiwyMi44IDEzLjUsMjIuOCBMMTUuNSwyMi44IEMxNS43NzYxNDI0LDIyLjggMTYsMjIuNTc2MTQyNCAxNiwyMi4zIEMxNiwyMi4wMjM4NTc2IDE2LjIyMzg1NzYsMjEuOCAxNi41LDIxLjggTDE3LDIxLjggQzE3LjI3NjE0MjQsMjEuOCAxNy41LDIyLjAyMzg1NzYgMTcuNSwyMi4zIEwxNy41LDIyLjU5IEMxNy40OTgwMzM5LDIyLjcyNTU4NTggMTcuNTUyMzQxNiwyMi44NTU5MjQ0IDE3LjY1LDIyLjk1IEwxOC4xNSwyMy40NSBDMTguMzQwNTcxNCwyMy42NDQ0MjE4IDE4LjM0MDU3MTQsMjMuOTU1NTc4MiAxOC4xNSwyNC4xNSBMMTYuNjQsMjUuNjUgQzE2LjU0OTcxOTcsMjUuNzQ3MTM4MyAxNi40MjI2MDM5LDI1LjgwMTYxNjUgMTYuMjksMjUuOCBMMTIuNzEsMjUuOCBDMTIuNTc3Mzk2MSwyNS44MDE2MTY1IDEyLjQ1MDI4MDMsMjUuNzQ3MTM4MyAxMi4zNiwyNS42NSBMMTAuODUsMjQuMTUgQzEwLjY1OTQyODYsMjMuOTU1NTc4MiAxMC42NTk0Mjg2LDIzLjY0NDQyMTggMTAuODUsMjMuNDUgWiIgaWQ9IlNoYXBlIiBmaWxsPSIjN0M4N0E1IiBvcGFjaXR5PSIwLjUiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTIxLjUsMjcuNSBMMjYuNSwyNy41IEwyNi41LDMxLjUgQzI2LjUsMzIuMDUyMjg0NyAyNi4wNTIyODQ3LDMyLjUgMjUuNSwzMi41IEwyMS41LDMyLjUgTDIxLjUsMjcuNSBaIiBpZD0iU2hhcGUiIHN0cm9rZT0iI0NDNEMyMyIgZmlsbD0iI0YxNUEyOSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48L3BhdGg+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=';\n/**\n * String with Ev3 expected pairing pin.\n * @readonly\n */\nvar Ev3PairingPin = '1234';\n/**\n * A maximum number of BT message sends per second, to be enforced by the rate limiter.\n * @type {number}\n */\nvar BTSendRateMax = 40;\n/**\n * Enum for Ev3 parameter encodings of various argument and return values.\n * Found in the 'EV3 Firmware Developer Kit', section4, page 9, at\n * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.\n *\n * The format for these values is:\n * 0xxxxxxx for Short Format\n * 1ttt-bbb for Long Format\n *\n * @readonly\n * @enum {number}\n */\nvar Ev3Encoding = {\n  ONE_BYTE: 0x81,\n  // = 0b1000-001, \"1 byte to follow\"\n  TWO_BYTES: 0x82,\n  // = 0b1000-010, \"2 bytes to follow\"\n  FOUR_BYTES: 0x83,\n  // = 0b1000-011, \"4 bytes to follow\"\n  GLOBAL_VARIABLE_ONE_BYTE: 0xE1,\n  // = 0b1110-001, \"1 byte to follow\"\n  GLOBAL_CONSTANT_INDEX_0: 0x20,\n  // = 0b00100000\n  GLOBAL_VARIABLE_INDEX_0: 0x60 // = 0b01100000\n};\n/**\n * Enum for Ev3 direct command types.\n * Found in the 'EV3 Communication Developer Kit', section 4, page 24, at\n * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.\n * @readonly\n * @enum {number}\n */\nvar Ev3Command = {\n  DIRECT_COMMAND_REPLY: 0x00,\n  DIRECT_COMMAND_NO_REPLY: 0x80,\n  DIRECT_REPLY: 0x02\n};\n/**\n * Enum for Ev3 commands opcodes.\n * Found in the 'EV3 Firmware Developer Kit', section 4, page 10, at\n * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.\n * @readonly\n * @enum {number}\n */\nvar Ev3Opcode = {\n  OPOUTPUT_STEP_SPEED: 0xAE,\n  OPOUTPUT_TIME_SPEED: 0xAF,\n  OPOUTPUT_STOP: 0xA3,\n  OPOUTPUT_RESET: 0xA2,\n  OPOUTPUT_STEP_SYNC: 0xB0,\n  OPOUTPUT_TIME_SYNC: 0xB1,\n  OPOUTPUT_GET_COUNT: 0xB3,\n  OPSOUND: 0x94,\n  OPSOUND_CMD_TONE: 1,\n  OPSOUND_CMD_STOP: 0,\n  OPINPUT_DEVICE_LIST: 0x98,\n  OPINPUT_READSI: 0x9D\n};\n/**\n * Enum for Ev3 values used as arguments to various opcodes.\n * Found in the 'EV3 Firmware Developer Kit', section4, page 10-onwards, at\n * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.\n * @readonly\n * @enum {number}\n */\nvar Ev3Args = {\n  LAYER: 0,\n  // always 0, chained EV3s not supported\n  COAST: 0,\n  BRAKE: 1,\n  RAMP: 50,\n  // time in milliseconds\n  DO_NOT_CHANGE_TYPE: 0,\n  MAX_DEVICES: 32 // 'Normally 32' from pg. 46\n};\n/**\n * Enum for Ev3 device type numbers.\n * Found in the 'EV3 Firmware Developer Kit', section 5, page 100, at\n * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.\n * @readonly\n * @enum {string}\n */\nvar Ev3Device = {\n  29: 'color',\n  30: 'ultrasonic',\n  32: 'gyro',\n  16: 'touch',\n  8: 'mediumMotor',\n  7: 'largeMotor',\n  126: 'none',\n  125: 'none'\n};\n/**\n * Enum for Ev3 device modes.\n * Found in the 'EV3 Firmware Developer Kit', section 5, page 100, at\n * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.\n * @readonly\n * @enum {number}\n */\nvar Ev3Mode = {\n  touch: 0,\n  // touch\n  color: 1,\n  // ambient\n  ultrasonic: 1,\n  // inch\n  none: 0\n};\n/**\n * Enum for Ev3 device labels used in the Scratch blocks/UI.\n * @readonly\n * @enum {string}\n */\nvar Ev3Label = {\n  touch: 'button',\n  color: 'brightness',\n  ultrasonic: 'distance'\n};\n/**\n * Manage power, direction, and timers for one EV3 motor.\n */\nvar EV3Motor = function () {\n  /**\n   * Construct a EV3 Motor instance, which could be of type 'largeMotor' or\n   * 'mediumMotor'.\n   *\n   * @param {EV3} parent - the EV3 peripheral which owns this motor.\n   * @param {int} index - the zero-based index of this motor on its parent peripheral.\n   * @param {string} type - the type of motor (i.e. 'largeMotor' or 'mediumMotor').\n   */\n  function EV3Motor(parent, index, type) {\n    _classCallCheck(this, EV3Motor);\n    /**\n     * The EV3 peripheral which owns this motor.\n     * @type {EV3}\n     * @private\n     */\n    this._parent = parent;\n    /**\n     * The zero-based index of this motor on its parent peripheral.\n     * @type {int}\n     * @private\n     */\n    this._index = index;\n    /**\n     * The type of EV3 motor this could be: 'largeMotor' or 'mediumMotor'.\n     * @type {string}\n     * @private\n     */\n    this._type = type;\n    /**\n     * This motor's current direction: 1 for \"clockwise\" or -1 for \"counterclockwise\"\n     * @type {number}\n     * @private\n     */\n    this._direction = 1;\n    /**\n     * This motor's current power level, in the range [0,100].\n     * @type {number}\n     * @private\n     */\n    this._power = 50;\n    /**\n     * This motor's current position, in the range [0,360].\n     * @type {number}\n     * @private\n     */\n    this._position = 0;\n    /**\n     * An ID for the current coast command, to help override multiple coast\n     * commands sent in succession.\n     * @type {number}\n     * @private\n     */\n    this._commandID = null;\n    /**\n     * A delay, in milliseconds, to add to coasting, to make sure that a brake\n     * first takes effect if one was sent.\n     * @type {number}\n     * @private\n     */\n    this._coastDelay = 1000;\n  }\n  /**\n   * @return {string} - this motor's type: 'largeMotor' or 'mediumMotor'\n   */\n  _createClass(EV3Motor, [{\n    key: \"turnOnFor\",\n    /**\n     * Turn this motor on for a specific duration.\n     * Found in the 'EV3 Firmware Developer Kit', page 56, at\n     * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.\n     *\n     * Opcode arguments:\n     * (Data8) LAYER – Specify chain layer number [0 - 3]\n     * (Data8) NOS – Output bit field [0x00 – 0x0F]\n     * (Data8) SPEED – Power level, [-100 – 100]\n     * (Data32) STEP1 – Time in milliseconds for ramp up\n     * (Data32) STEP2 – Time in milliseconds for continues run\n     * (Data32) STEP3 – Time in milliseconds for ramp down\n     * (Data8) BRAKE - Specify break level [0: Float, 1: Break]\n     *\n     * @param {number} milliseconds - run the motor for this long.\n     */\n    value: function turnOnFor(milliseconds) {\n      if (this._power === 0) return;\n      var port = this._portMask(this._index);\n      var n = milliseconds;\n      var speed = this._power * this._direction;\n      var ramp = Ev3Args.RAMP;\n      var byteCommand = [];\n      byteCommand[0] = Ev3Opcode.OPOUTPUT_TIME_SPEED; // If speed is less than zero, make it positive and multiply the input\n      // value by -1\n      if (speed < 0) {\n        speed = -1 * speed;\n        n = -1 * n;\n      } // If the input value is less than 0\n      var dir = n < 0 ? 0x100 - speed : speed; // step negative or positive\n      n = Math.abs(n); // Setup motor run duration and ramping behavior\n      var rampup = ramp;\n      var rampdown = ramp;\n      var run = n - ramp * 2;\n      if (run < 0) {\n        rampup = Math.floor(n / 2);\n        run = 0;\n        rampdown = n - rampup;\n      } // Generate motor command values\n      var runcmd = this._runValues(run);\n      byteCommand = byteCommand.concat([Ev3Args.LAYER, port, Ev3Encoding.ONE_BYTE, dir & 0xff, Ev3Encoding.ONE_BYTE, rampup]).concat(runcmd.concat([Ev3Encoding.ONE_BYTE, rampdown, Ev3Args.BRAKE]));\n      var cmd = this._parent.generateCommand(Ev3Command.DIRECT_COMMAND_NO_REPLY, byteCommand);\n      this._parent.send(cmd);\n      this.coastAfter(milliseconds);\n    }\n    /**\n     * Set the motor to coast after a specified amount of time.\n     * @param {number} time - the time in milliseconds.\n     */\n  }, {\n    key: \"coastAfter\",\n    value: function coastAfter(time) {\n      var _this = this;\n      if (this._power === 0) return; // Set the motor command id to check before starting coast\n      var commandId = uid();\n      this._commandID = commandId; // Send coast message\n      setTimeout(function () {\n        // Do not send coast if another motor command changed the command id.\n        if (_this._commandID === commandId) {\n          _this.coast();\n          _this._commandID = null;\n        }\n      }, time + this._coastDelay); // add a delay so the brake takes effect\n    }\n    /**\n     * Set the motor to coast.\n     */\n  }, {\n    key: \"coast\",\n    value: function coast() {\n      if (this._power === 0) return;\n      var cmd = this._parent.generateCommand(Ev3Command.DIRECT_COMMAND_NO_REPLY, [Ev3Opcode.OPOUTPUT_STOP, Ev3Args.LAYER, this._portMask(this._index), // port output bit field\n      Ev3Args.COAST]);\n      this._parent.send(cmd, false); // don't use rate limiter to ensure motor stops\n    }\n    /**\n     * Generate motor run values for a given input.\n     * @param  {number} run - run input.\n     * @return {array} - run values as a byte array.\n     */\n  }, {\n    key: \"_runValues\",\n    value: function _runValues(run) {\n      // If run duration is less than max 16-bit integer\n      if (run < 0x7fff) {\n        return [Ev3Encoding.TWO_BYTES, run & 0xff, run >> 8 & 0xff];\n      } // Run forever\n      return [Ev3Encoding.FOUR_BYTES, run & 0xff, run >> 8 & 0xff, run >> 16 & 0xff, run >> 24 & 0xff];\n    }\n    /**\n     * Return a port value for the EV3 that is in the format for 'output bit field'\n     * as 1/2/4/8, generally needed for motor ports, instead of the typical 0/1/2/3.\n     * The documentation in the 'EV3 Firmware Developer Kit' for motor port arguments\n     * is sometimes mistaken, but we believe motor ports are mostly addressed this way.\n     * @param {number} port - the port number to convert to an 'output bit field'.\n     * @return {number} - the converted port number.\n     */\n  }, {\n    key: \"_portMask\",\n    value: function _portMask(port) {\n      return Math.pow(2, port);\n    }\n  }, {\n    key: \"type\",\n    get: function get() {\n      return this._type;\n    }\n    /**\n     * @param {string} value - this motor's new type: 'largeMotor' or 'mediumMotor'\n     */\n    ,\n    set: function set(value) {\n      this._type = value;\n    }\n    /**\n     * @return {int} - this motor's current direction: 1 for \"clockwise\" or -1 for \"counterclockwise\"\n     */\n  }, {\n    key: \"direction\",\n    get: function get() {\n      return this._direction;\n    }\n    /**\n     * @param {int} value - this motor's new direction: 1 for \"clockwise\" or -1 for \"counterclockwise\"\n     */\n    ,\n    set: function set(value) {\n      if (value < 0) {\n        this._direction = -1;\n      } else {\n        this._direction = 1;\n      }\n    }\n    /**\n     * @return {int} - this motor's current power level, in the range [0,100].\n     */\n  }, {\n    key: \"power\",\n    get: function get() {\n      return this._power;\n    }\n    /**\n     * @param {int} value - this motor's new power level, in the range [0,100].\n     */\n    ,\n    set: function set(value) {\n      this._power = value;\n    }\n    /**\n     * @return {int} - this motor's current position, in the range [-inf,inf].\n     */\n  }, {\n    key: \"position\",\n    get: function get() {\n      return this._position;\n    }\n    /**\n     * @param {int} array - this motor's new position, in the range [0,360].\n     */\n    ,\n    set: function set(array) {\n      // tachoValue from Paula\n      var value = array[0] + array[1] * 256 + array[2] * 256 * 256 + array[3] * 256 * 256 * 256;\n      if (value > 0x7fffffff) {\n        value = value - 0x100000000;\n      }\n      this._position = value;\n    }\n  }]);\n  return EV3Motor;\n}();\nvar EV3 = function () {\n  function EV3(runtime, extensionId) {\n    _classCallCheck(this, EV3);\n    /**\n     * The Scratch 3.0 runtime used to trigger the green flag button.\n     * @type {Runtime}\n     * @private\n     */\n    this._runtime = runtime;\n    this._runtime.on('PROJECT_STOP_ALL', this.stopAll.bind(this));\n    /**\n     * The id of the extension this peripheral belongs to.\n     */\n    this._extensionId = extensionId;\n    /**\n     * A list of the names of the sensors connected in ports 1,2,3,4.\n     * @type {string[]}\n     * @private\n     */\n    this._sensorPorts = [];\n    /**\n     * A list of the names of the motors connected in ports A,B,C,D.\n     * @type {string[]}\n     * @private\n     */\n    this._motorPorts = [];\n    /**\n     * The state of all sensor values.\n     * @type {string[]}\n     * @private\n     */\n    this._sensors = {\n      distance: 0,\n      brightness: 0,\n      buttons: [0, 0, 0, 0]\n    };\n    /**\n     * The motors which this EV3 could possibly have connected.\n     * @type {string[]}\n     * @private\n     */\n    this._motors = [null, null, null, null];\n    /**\n     * The polling interval, in milliseconds.\n     * @type {number}\n     * @private\n     */\n    this._pollingInterval = 150;\n    /**\n     * The polling interval ID.\n     * @type {number}\n     * @private\n     */\n    this._pollingIntervalID = null;\n    /**\n     * The counter keeping track of polling cycles.\n     * @type {string[]}\n     * @private\n     */\n    this._pollingCounter = 0;\n    /**\n     * The Bluetooth socket connection for reading/writing peripheral data.\n     * @type {BT}\n     * @private\n     */\n    this._bt = null;\n    this._runtime.registerPeripheralExtension(extensionId, this);\n    /**\n     * A rate limiter utility, to help limit the rate at which we send BT messages\n     * over the socket to Scratch Link to a maximum number of sends per second.\n     * @type {RateLimiter}\n     * @private\n     */\n    this._rateLimiter = new RateLimiter(BTSendRateMax);\n    this.reset = this.reset.bind(this);\n    this._onConnect = this._onConnect.bind(this);\n    this._onMessage = this._onMessage.bind(this);\n    this._pollValues = this._pollValues.bind(this);\n  }\n  _createClass(EV3, [{\n    key: \"motor\",\n    /**\n     * Access a particular motor on this peripheral.\n     * @param {int} index - the zero-based index of the desired motor.\n     * @return {EV3Motor} - the EV3Motor instance, if any, at that index.\n     */\n    value: function motor(index) {\n      return this._motors[index];\n    }\n  }, {\n    key: \"isButtonPressed\",\n    value: function isButtonPressed(port) {\n      return this._sensors.buttons[port] === 1;\n    }\n  }, {\n    key: \"beep\",\n    value: function beep(freq, time) {\n      var cmd = this.generateCommand(Ev3Command.DIRECT_COMMAND_NO_REPLY, [Ev3Opcode.OPSOUND, Ev3Opcode.OPSOUND_CMD_TONE, Ev3Encoding.ONE_BYTE, 2, Ev3Encoding.TWO_BYTES, freq, freq >> 8, Ev3Encoding.TWO_BYTES, time, time >> 8]);\n      this.send(cmd);\n    }\n  }, {\n    key: \"stopAll\",\n    value: function stopAll() {\n      this.stopAllMotors();\n      this.stopSound();\n    }\n  }, {\n    key: \"stopSound\",\n    value: function stopSound() {\n      var cmd = this.generateCommand(Ev3Command.DIRECT_COMMAND_NO_REPLY, [Ev3Opcode.OPSOUND, Ev3Opcode.OPSOUND_CMD_STOP]);\n      this.send(cmd, false); // don't use rate limiter to ensure sound stops\n    }\n  }, {\n    key: \"stopAllMotors\",\n    value: function stopAllMotors() {\n      this._motors.forEach(function (motor) {\n        if (motor) {\n          motor.coast();\n        }\n      });\n    }\n    /**\n     * Called by the runtime when user wants to scan for an EV3 peripheral.\n     */\n  }, {\n    key: \"scan\",\n    value: function scan() {\n      if (this._bt) {\n        this._bt.disconnect();\n      }\n      this._bt = new BT(this._runtime, this._extensionId, {\n        majorDeviceClass: 8,\n        minorDeviceClass: 1\n      }, this._onConnect, this.reset, this._onMessage);\n    }\n    /**\n     * Called by the runtime when user wants to connect to a certain EV3 peripheral.\n     * @param {number} id - the id of the peripheral to connect to.\n     */\n  }, {\n    key: \"connect\",\n    value: function connect(id) {\n      if (this._bt) {\n        this._bt.connectPeripheral(id, Ev3PairingPin);\n      }\n    }\n    /**\n     * Called by the runtime when user wants to disconnect from the EV3 peripheral.\n     */\n  }, {\n    key: \"disconnect\",\n    value: function disconnect() {\n      if (this._bt) {\n        this._bt.disconnect();\n      }\n      this.reset();\n    }\n    /**\n     * Reset all the state and timeout/interval ids.\n     */\n  }, {\n    key: \"reset\",\n    value: function reset() {\n      this._sensorPorts = [];\n      this._motorPorts = [];\n      this._sensors = {\n        distance: 0,\n        brightness: 0,\n        buttons: [0, 0, 0, 0]\n      };\n      this._motors = [null, null, null, null];\n      if (this._pollingIntervalID) {\n        window.clearInterval(this._pollingIntervalID);\n        this._pollingIntervalID = null;\n      }\n    }\n    /**\n     * Called by the runtime to detect whether the EV3 peripheral is connected.\n     * @return {boolean} - the connected state.\n     */\n  }, {\n    key: \"isConnected\",\n    value: function isConnected() {\n      var connected = false;\n      if (this._bt) {\n        connected = this._bt.isConnected();\n      }\n      return connected;\n    }\n    /**\n     * Send a message to the peripheral BT socket.\n     * @param {Uint8Array} message - the message to send.\n     * @param {boolean} [useLimiter=true] - if true, use the rate limiter\n     * @return {Promise} - a promise result of the send operation.\n     */\n  }, {\n    key: \"send\",\n    value: function send(message) {\n      var useLimiter = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n      if (!this.isConnected()) return Promise.resolve();\n      if (useLimiter) {\n        if (!this._rateLimiter.okayToSend()) return Promise.resolve();\n      }\n      return this._bt.sendMessage({\n        message: Base64Util.uint8ArrayToBase64(message),\n        encoding: 'base64'\n      });\n    }\n    /**\n     * Genrates direct commands that are sent to the EV3 as a single or compounded byte arrays.\n     * See 'EV3 Communication Developer Kit', section 4, page 24 at\n     * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.\n     *\n     * Direct commands are one of two types:\n     * DIRECT_COMMAND_NO_REPLY = a direct command where no reply is expected\n     * DIRECT_COMMAND_REPLY = a direct command where a reply is expected, and the\n     * number and length of returned values needs to be specified.\n     *\n     * The direct command byte array sent takes the following format:\n     * Byte 0 - 1: Command size, Little Endian. Command size not including these 2 bytes\n     * Byte 2 - 3: Message counter, Little Endian. Forth running counter\n     * Byte 4:     Command type. Either DIRECT_COMMAND_REPLY or DIRECT_COMMAND_NO_REPLY\n     * Byte 5 - 6: Reservation (allocation) of global and local variables using a compressed format\n     *             (globals reserved in byte 5 and the 2 lsb of byte 6, locals reserved in the upper\n     *             6 bits of byte 6) – see documentation for more details.\n     * Byte 7 - n: Byte codes as a single command or compound commands (I.e. more commands composed\n     *             as a small program)\n     *\n     * @param {number} type - the direct command type.\n     * @param {string} byteCommands - a compound array of EV3 Opcode + arguments.\n     * @param {number} allocation - the allocation of global and local vars needed for replies.\n     * @return {array} - generated complete command byte array, with header and compounded commands.\n     */\n  }, {\n    key: \"generateCommand\",\n    value: function generateCommand(type, byteCommands) {\n      var allocation = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;\n      // Header (Bytes 0 - 6)\n      var command = [];\n      command[2] = 0; // Message counter unused for now\n      command[3] = 0; // Message counter unused for now\n      command[4] = type;\n      command[5] = allocation & 0xFF;\n      command[6] = allocation >> 8 && 0xFF; // Bytecodes (Bytes 7 - n)\n      command = command.concat(byteCommands); // Calculate command length minus first two header bytes\n      var len = command.length - 2;\n      command[0] = len & 0xFF;\n      command[1] = len >> 8 && 0xFF;\n      return command;\n    }\n    /**\n     * When the EV3 peripheral connects, start polling for sensor and motor values.\n     * @private\n     */\n  }, {\n    key: \"_onConnect\",\n    value: function _onConnect() {\n      this._pollingIntervalID = window.setInterval(this._pollValues, this._pollingInterval);\n    }\n    /**\n     * Poll the EV3 for sensor and motor input values, based on the list of\n     * known connected sensors and motors. This is sent as many compound commands\n     * in a direct command, with a reply expected.\n     *\n     * See 'EV3 Firmware Developer Kit', section 4.8, page 46, at\n     * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits\n     * for a list of polling/input device commands and their arguments.\n     *\n     * @private\n     */\n  }, {\n    key: \"_pollValues\",\n    value: function _pollValues() {\n      if (!this.isConnected()) {\n        window.clearInterval(this._pollingIntervalID);\n        return;\n      }\n      var cmds = []; // compound command\n      var allocation = 0;\n      var sensorCount = 0; // Reset the list of devices every 20 counts\n      if (this._pollingCounter % 20 === 0) {\n        // GET DEVICE LIST\n        cmds[0] = Ev3Opcode.OPINPUT_DEVICE_LIST;\n        cmds[1] = Ev3Encoding.ONE_BYTE;\n        cmds[2] = Ev3Args.MAX_DEVICES;\n        cmds[3] = Ev3Encoding.GLOBAL_VARIABLE_INDEX_0;\n        cmds[4] = Ev3Encoding.GLOBAL_VARIABLE_ONE_BYTE;\n        cmds[5] = Ev3Encoding.GLOBAL_CONSTANT_INDEX_0; // Command and payload lengths\n        allocation = 33;\n        this._updateDevices = true;\n      } else {\n        // GET SENSOR VALUES FOR CONNECTED SENSORS\n        var index = 0;\n        for (var i = 0; i < 4; i++) {\n          if (this._sensorPorts[i] !== 'none') {\n            cmds[index + 0] = Ev3Opcode.OPINPUT_READSI;\n            cmds[index + 1] = Ev3Args.LAYER;\n            cmds[index + 2] = i; // PORT\n            cmds[index + 3] = Ev3Args.DO_NOT_CHANGE_TYPE;\n            cmds[index + 4] = Ev3Mode[this._sensorPorts[i]];\n            cmds[index + 5] = Ev3Encoding.GLOBAL_VARIABLE_ONE_BYTE;\n            cmds[index + 6] = sensorCount * 4; // GLOBAL INDEX\n            index += 7;\n          }\n          sensorCount++;\n        } // GET MOTOR POSITION VALUES, EVEN IF NO MOTOR PRESENT\n        for (var _i = 0; _i < 4; _i++) {\n          cmds[index + 0] = Ev3Opcode.OPOUTPUT_GET_COUNT;\n          cmds[index + 1] = Ev3Args.LAYER;\n          cmds[index + 2] = _i; // PORT (incorrectly specified as 'Output bit field' in LEGO docs)\n          cmds[index + 3] = Ev3Encoding.GLOBAL_VARIABLE_ONE_BYTE;\n          cmds[index + 4] = sensorCount * 4; // GLOBAL INDEX\n          index += 5;\n          sensorCount++;\n        } // Command and payload lengths\n        allocation = sensorCount * 4;\n      }\n      var cmd = this.generateCommand(Ev3Command.DIRECT_COMMAND_REPLY, cmds, allocation);\n      this.send(cmd);\n      this._pollingCounter++;\n    }\n    /**\n     * Message handler for incoming EV3 reply messages, either a list of connected\n     * devices (sensors and motors) or the values of the connected sensors and motors.\n     *\n     * See 'EV3 Communication Developer Kit', section 4.1, page 24 at\n     * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits\n     * for more details on direct reply formats.\n     *\n     * The direct reply byte array sent takes the following format:\n     * Byte 0 – 1: Reply size, Little Endian. Reply size not including these 2 bytes\n     * Byte 2 – 3: Message counter, Little Endian. Equals the Direct Command\n     * Byte 4:     Reply type. Either DIRECT_REPLY or DIRECT_REPLY_ERROR\n     * Byte 5 - n: Resonse buffer. I.e. the content of the by the Command reserved global variables.\n     *             I.e. if the command reserved 64 bytes, these bytes will be placed in the reply\n     *             packet as the bytes 5 to 68.\n     *\n     * See 'EV3 Firmware Developer Kit', section 4.8, page 56 at\n     * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits\n     * for direct response buffer formats for various commands.\n     *\n     * @param {object} params - incoming message parameters\n     * @private\n     */\n  }, {\n    key: \"_onMessage\",\n    value: function _onMessage(params) {\n      var message = params.message;\n      var data = Base64Util.base64ToUint8Array(message);\n      if (data[4] !== Ev3Command.DIRECT_REPLY) {\n        return;\n      }\n      if (this._updateDevices) {\n        // PARSE DEVICE LIST\n        for (var i = 0; i < 4; i++) {\n          var deviceType = Ev3Device[data[i + 5]]; // if returned device type is null, use 'none'\n          this._sensorPorts[i] = deviceType ? deviceType : 'none';\n        }\n        for (var _i2 = 0; _i2 < 4; _i2++) {\n          var _deviceType = Ev3Device[data[_i2 + 21]]; // if returned device type is null, use 'none'\n          this._motorPorts[_i2] = _deviceType ? _deviceType : 'none';\n        }\n        for (var m = 0; m < 4; m++) {\n          var type = this._motorPorts[m];\n          if (type !== 'none' && !this._motors[m]) {\n            // add new motor if don't already have one\n            this._motors[m] = new EV3Motor(this, m, type);\n          }\n          if (type === 'none' && this._motors[m]) {\n            // clear old motor\n            this._motors[m] = null;\n          }\n        }\n        this._updateDevices = false; // eslint-disable-next-line no-undefined\n      } else if (!this._sensorPorts.includes(undefined) && !this._motorPorts.includes(undefined)) {\n        // PARSE SENSOR VALUES\n        var offset = 5; // start reading sensor values at byte 5\n        for (var _i3 = 0; _i3 < 4; _i3++) {\n          // array 2 float\n          var buffer = new Uint8Array([data[offset], data[offset + 1], data[offset + 2], data[offset + 3]]).buffer;\n          var view = new DataView(buffer);\n          var value = view.getFloat32(0, true);\n          if (Ev3Label[this._sensorPorts[_i3]] === 'button') {\n            // Read a button value per port\n            this._sensors.buttons[_i3] = value ? value : 0;\n          } else if (Ev3Label[this._sensorPorts[_i3]]) {\n            // if valid\n            // Read brightness / distance values and set to 0 if null\n            this._sensors[Ev3Label[this._sensorPorts[_i3]]] = value ? value : 0;\n          }\n          offset += 4;\n        } // PARSE MOTOR POSITION VALUES, EVEN IF NO MOTOR PRESENT\n        for (var _i4 = 0; _i4 < 4; _i4++) {\n          var positionArray = [data[offset], data[offset + 1], data[offset + 2], data[offset + 3]];\n          if (this._motors[_i4]) {\n            this._motors[_i4].position = positionArray;\n          }\n          offset += 4;\n        }\n      }\n    }\n  }, {\n    key: \"distance\",\n    get: function get() {\n      var value = this._sensors.distance > 100 ? 100 : this._sensors.distance;\n      value = value < 0 ? 0 : value;\n      value = Math.round(100 * value) / 100;\n      return value;\n    }\n  }, {\n    key: \"brightness\",\n    get: function get() {\n      return this._sensors.brightness;\n    }\n  }]);\n  return EV3;\n}();\n/**\n * Enum for motor port names.\n * Note: if changed, will break compatibility with previously saved projects.\n * @readonly\n * @enum {string}\n */\nvar Ev3MotorMenu = ['A', 'B', 'C', 'D'];\n/**\n * Enum for sensor port names.\n * Note: if changed, will break compatibility with previously saved projects.\n * @readonly\n * @enum {string}\n */\nvar Ev3SensorMenu = ['1', '2', '3', '4'];\nvar Scratch3Ev3Blocks = function () {\n  _createClass(Scratch3Ev3Blocks, null, [{\n    key: \"EXTENSION_ID\",\n    /**\n     * The ID of the extension.\n     * @return {string} the id\n     */\n    get: function get() {\n      return 'ev3';\n    }\n    /**\n     * Creates a new instance of the EV3 extension.\n     * @param  {object} runtime VM runtime\n     * @constructor\n     */\n  }]);\n  function Scratch3Ev3Blocks(runtime) {\n    _classCallCheck(this, Scratch3Ev3Blocks);\n    /**\n     * The Scratch 3.0 runtime.\n     * @type {Runtime}\n     */\n    this.runtime = runtime; // Create a new EV3 peripheral instance\n    this._peripheral = new EV3(this.runtime, Scratch3Ev3Blocks.EXTENSION_ID);\n    this._playNoteForPicker = this._playNoteForPicker.bind(this);\n    this.runtime.on('PLAY_NOTE', this._playNoteForPicker);\n  }\n  /**\n   * Define the EV3 extension.\n   * @return {object} Extension description.\n   */\n  _createClass(Scratch3Ev3Blocks, [{\n    key: \"getInfo\",\n    value: function getInfo() {\n      return {\n        id: Scratch3Ev3Blocks.EXTENSION_ID,\n        name: 'LEGO EV3',\n        blockIconURI: blockIconURI,\n        showStatusButton: true,\n        blocks: [{\n          opcode: 'motorTurnClockwise',\n          text: formatMessage({\n            id: 'ev3.motorTurnClockwise',\n            default: 'motor [PORT] turn this way for [TIME] seconds',\n            description: 'turn a motor clockwise for some time'\n          }),\n          blockType: BlockType.COMMAND,\n          arguments: {\n            PORT: {\n              type: ArgumentType.STRING,\n              menu: 'motorPorts',\n              defaultValue: 0\n            },\n            TIME: {\n              type: ArgumentType.NUMBER,\n              defaultValue: 1\n            }\n          }\n        }, {\n          opcode: 'motorTurnCounterClockwise',\n          text: formatMessage({\n            id: 'ev3.motorTurnCounterClockwise',\n            default: 'motor [PORT] turn that way for [TIME] seconds',\n            description: 'turn a motor counter-clockwise for some time'\n          }),\n          blockType: BlockType.COMMAND,\n          arguments: {\n            PORT: {\n              type: ArgumentType.STRING,\n              menu: 'motorPorts',\n              defaultValue: 0\n            },\n            TIME: {\n              type: ArgumentType.NUMBER,\n              defaultValue: 1\n            }\n          }\n        }, {\n          opcode: 'motorSetPower',\n          text: formatMessage({\n            id: 'ev3.motorSetPower',\n            default: 'motor [PORT] set power [POWER] %',\n            description: 'set a motor\\'s power to some value'\n          }),\n          blockType: BlockType.COMMAND,\n          arguments: {\n            PORT: {\n              type: ArgumentType.STRING,\n              menu: 'motorPorts',\n              defaultValue: 0\n            },\n            POWER: {\n              type: ArgumentType.NUMBER,\n              defaultValue: 100\n            }\n          }\n        }, {\n          opcode: 'getMotorPosition',\n          text: formatMessage({\n            id: 'ev3.getMotorPosition',\n            default: 'motor [PORT] position',\n            description: 'get the measured degrees a motor has turned'\n          }),\n          blockType: BlockType.REPORTER,\n          arguments: {\n            PORT: {\n              type: ArgumentType.STRING,\n              menu: 'motorPorts',\n              defaultValue: 0\n            }\n          }\n        }, {\n          opcode: 'whenButtonPressed',\n          text: formatMessage({\n            id: 'ev3.whenButtonPressed',\n            default: 'when button [PORT] pressed',\n            description: 'when a button connected to a port is pressed'\n          }),\n          blockType: BlockType.HAT,\n          arguments: {\n            PORT: {\n              type: ArgumentType.STRING,\n              menu: 'sensorPorts',\n              defaultValue: 0\n            }\n          }\n        }, {\n          opcode: 'whenDistanceLessThan',\n          text: formatMessage({\n            id: 'ev3.whenDistanceLessThan',\n            default: 'when distance < [DISTANCE]',\n            description: 'when the value measured by the distance sensor is less than some value'\n          }),\n          blockType: BlockType.HAT,\n          arguments: {\n            DISTANCE: {\n              type: ArgumentType.NUMBER,\n              defaultValue: 5\n            }\n          }\n        }, {\n          opcode: 'whenBrightnessLessThan',\n          text: formatMessage({\n            id: 'ev3.whenBrightnessLessThan',\n            default: 'when brightness < [DISTANCE]',\n            description: 'when value measured by brightness sensor is less than some value'\n          }),\n          blockType: BlockType.HAT,\n          arguments: {\n            DISTANCE: {\n              type: ArgumentType.NUMBER,\n              defaultValue: 50\n            }\n          }\n        }, {\n          opcode: 'buttonPressed',\n          text: formatMessage({\n            id: 'ev3.buttonPressed',\n            default: 'button [PORT] pressed?',\n            description: 'is a button on some port pressed?'\n          }),\n          blockType: BlockType.BOOLEAN,\n          arguments: {\n            PORT: {\n              type: ArgumentType.STRING,\n              menu: 'sensorPorts',\n              defaultValue: 0\n            }\n          }\n        }, {\n          opcode: 'getDistance',\n          text: formatMessage({\n            id: 'ev3.getDistance',\n            default: 'distance',\n            description: 'gets measured distance'\n          }),\n          blockType: BlockType.REPORTER\n        }, {\n          opcode: 'getBrightness',\n          text: formatMessage({\n            id: 'ev3.getBrightness',\n            default: 'brightness',\n            description: 'gets measured brightness'\n          }),\n          blockType: BlockType.REPORTER\n        }, {\n          opcode: 'beep',\n          text: formatMessage({\n            id: 'ev3.beepNote',\n            default: 'beep note [NOTE] for [TIME] secs',\n            description: 'play some note on EV3 for some time'\n          }),\n          blockType: BlockType.COMMAND,\n          arguments: {\n            NOTE: {\n              type: ArgumentType.NOTE,\n              defaultValue: 60\n            },\n            TIME: {\n              type: ArgumentType.NUMBER,\n              defaultValue: 0.5\n            }\n          }\n        }],\n        menus: {\n          motorPorts: {\n            acceptReporters: true,\n            items: this._formatMenu(Ev3MotorMenu)\n          },\n          sensorPorts: {\n            acceptReporters: true,\n            items: this._formatMenu(Ev3SensorMenu)\n          }\n        }\n      };\n    }\n  }, {\n    key: \"motorTurnClockwise\",\n    value: function motorTurnClockwise(args) {\n      var _this2 = this;\n      var port = Cast.toNumber(args.PORT);\n      var time = Cast.toNumber(args.TIME) * 1000;\n      time = MathUtil.clamp(time, 0, 15000);\n      return new Promise(function (resolve) {\n        _this2._forEachMotor(port, function (motorIndex) {\n          var motor = _this2._peripheral.motor(motorIndex);\n          if (motor) {\n            motor.direction = 1;\n            motor.turnOnFor(time);\n          }\n        }); // Run for some time even when no motor is connected\n        setTimeout(resolve, time);\n      });\n    }\n  }, {\n    key: \"motorTurnCounterClockwise\",\n    value: function motorTurnCounterClockwise(args) {\n      var _this3 = this;\n      var port = Cast.toNumber(args.PORT);\n      var time = Cast.toNumber(args.TIME) * 1000;\n      time = MathUtil.clamp(time, 0, 15000);\n      return new Promise(function (resolve) {\n        _this3._forEachMotor(port, function (motorIndex) {\n          var motor = _this3._peripheral.motor(motorIndex);\n          if (motor) {\n            motor.direction = -1;\n            motor.turnOnFor(time);\n          }\n        }); // Run for some time even when no motor is connected\n        setTimeout(resolve, time);\n      });\n    }\n  }, {\n    key: \"motorSetPower\",\n    value: function motorSetPower(args) {\n      var _this4 = this;\n      var port = Cast.toNumber(args.PORT);\n      var power = MathUtil.clamp(Cast.toNumber(args.POWER), 0, 100);\n      this._forEachMotor(port, function (motorIndex) {\n        var motor = _this4._peripheral.motor(motorIndex);\n        if (motor) {\n          motor.power = power;\n        }\n      });\n    }\n  }, {\n    key: \"getMotorPosition\",\n    value: function getMotorPosition(args) {\n      var port = Cast.toNumber(args.PORT);\n      if (![0, 1, 2, 3].includes(port)) {\n        return;\n      }\n      var motor = this._peripheral.motor(port);\n      var position = 0;\n      if (motor) {\n        position = MathUtil.wrapClamp(motor.position, 0, 360);\n      }\n      return position;\n    }\n  }, {\n    key: \"whenButtonPressed\",\n    value: function whenButtonPressed(args) {\n      var port = Cast.toNumber(args.PORT);\n      if (![0, 1, 2, 3].includes(port)) {\n        return;\n      }\n      return this._peripheral.isButtonPressed(port);\n    }\n  }, {\n    key: \"whenDistanceLessThan\",\n    value: function whenDistanceLessThan(args) {\n      var distance = MathUtil.clamp(Cast.toNumber(args.DISTANCE), 0, 100);\n      return this._peripheral.distance < distance;\n    }\n  }, {\n    key: \"whenBrightnessLessThan\",\n    value: function whenBrightnessLessThan(args) {\n      var brightness = MathUtil.clamp(Cast.toNumber(args.DISTANCE), 0, 100);\n      return this._peripheral.brightness < brightness;\n    }\n  }, {\n    key: \"buttonPressed\",\n    value: function buttonPressed(args) {\n      var port = Cast.toNumber(args.PORT);\n      if (![0, 1, 2, 3].includes(port)) {\n        return;\n      }\n      return this._peripheral.isButtonPressed(port);\n    }\n  }, {\n    key: \"getDistance\",\n    value: function getDistance() {\n      return this._peripheral.distance;\n    }\n  }, {\n    key: \"getBrightness\",\n    value: function getBrightness() {\n      return this._peripheral.brightness;\n    }\n  }, {\n    key: \"_playNoteForPicker\",\n    value: function _playNoteForPicker(note, category) {\n      if (category !== this.getInfo().name) return;\n      this.beep({\n        NOTE: note,\n        TIME: 0.25\n      });\n    }\n  }, {\n    key: \"beep\",\n    value: function beep(args) {\n      var _this5 = this;\n      var note = MathUtil.clamp(Cast.toNumber(args.NOTE), 47, 99); // valid EV3 sounds\n      var time = Cast.toNumber(args.TIME) * 1000;\n      time = MathUtil.clamp(time, 0, 3000);\n      if (time === 0) {\n        return; // don't send a beep time of 0\n      }\n      return new Promise(function (resolve) {\n        // https://en.wikipedia.org/wiki/MIDI_tuning_standard#Frequency_values\n        var freq = Math.pow(2, (note - 69 + 12) / 12) * 440;\n        _this5._peripheral.beep(freq, time); // Run for some time even when no piezo is connected.\n        setTimeout(resolve, time);\n      });\n    }\n    /**\n     * Call a callback for each motor indexed by the provided motor ID.\n     *\n     * Note: This way of looping through motors is currently unnecessary, but could be\n     * useful if an 'all motors' option is added in the future (see WeDo2 extension).\n     *\n     * @param {MotorID} motorID - the ID specifier.\n     * @param {Function} callback - the function to call with the numeric motor index for each motor.\n     * @private\n     */\n  }, {\n    key: \"_forEachMotor\",\n    value: function _forEachMotor(motorID, callback) {\n      var motors;\n      switch (motorID) {\n        case 0:\n          motors = [0];\n          break;\n        case 1:\n          motors = [1];\n          break;\n        case 2:\n          motors = [2];\n          break;\n        case 3:\n          motors = [3];\n          break;\n        default:\n          log.warn(\"Invalid motor ID: \".concat(motorID));\n          motors = [];\n          break;\n      }\n      var _iterator = _createForOfIteratorHelper(motors),\n          _step;\n      try {\n        for (_iterator.s(); !(_step = _iterator.n()).done;) {\n          var index = _step.value;\n          callback(index);\n        }\n      } catch (err) {\n        _iterator.e(err);\n      } finally {\n        _iterator.f();\n      }\n    }\n    /**\n     * Formats menus into a format suitable for block menus, and loading previously\n     * saved projects:\n     * [\n     *   {\n     *    text: label,\n     *    value: index\n     *   },\n     *   {\n     *    text: label,\n     *    value: index\n     *   },\n     *   etc...\n     * ]\n     *\n     * @param {array} menu - a menu to format.\n     * @return {object} - a formatted menu as an object.\n     * @private\n     */\n  }, {\n    key: \"_formatMenu\",\n    value: function _formatMenu(menu) {\n      var m = [];\n      for (var i = 0; i < menu.length; i++) {\n        var obj = {};\n        obj.text = menu[i];\n        obj.value = i.toString();\n        m.push(obj);\n      }\n      return m;\n    }\n  }]);\n  return Scratch3Ev3Blocks;\n}();\nmodule.exports = Scratch3Ev3Blocks;\n })